const images = {
  1: [
    {src: "https://fatthatmablog.wordpress.com/wp-content/uploads/2025/11/01.png", alt: "خيال علمي"},
    {src: "https://fatthatmablog.wordpress.com/wp-content/uploads/2025/11/02.png", alt: "رعب"},
    {src: "https://fatthatmablog.wordpress.com/wp-content/uploads/2025/11/03.png", alt: "فانتازيا"},
    {src: "https://fatthatmablog.wordpress.com/wp-content/uploads/2025/11/04.png", alt: "غموض"},
    {src: "https://fatthatmablog.wordpress.com/wp-content/uploads/2025/11/05.png", alt: "رومانسي"},
    {src: "https://fatthatmablog.wordpress.com/wp-content/uploads/2025/11/06.png", alt: "تاريخي"},
    {src: "https://fatthatmablog.wordpress.com/wp-content/uploads/2025/11/07.png", alt: "مغامرة"},
    {src: "https://fatthatmablog.wordpress.com/wp-content/uploads/2025/11/08.png", alt: "كوميدي"}
  ],
  2: [
    {src: "https://fatthatmablog.wordpress.com/wp-content/uploads/2025/11/01-1.png", alt: "الزمن الحاضر"},
    {src: "https://fatthatmablog.wordpress.com/wp-content/uploads/2025/11/02-1.png", alt: "الماضي البعيد"},
    {src: "https://fatthatmablog.wordpress.com/wp-content/uploads/2025/11/03-1.png", alt: "المستقبل القريب"},
    {src: "https://fatthatmablog.wordpress.com/wp-content/uploads/2025/11/04-1.png", alt: "الماضي القريب"},
    {src: "https://fatthatmablog.wordpress.com/wp-content/uploads/2025/11/05-1.png", alt: "المستقبل البعيد"},
    {src: "https://fatthatmablog.wordpress.com/wp-content/uploads/2025/11/06-1.png", alt: "أزمنة متقاطعة"},
    {src: "https://fatthatmablog.wordpress.com/wp-content/uploads/2025/11/07-1.png", alt: "زمن غير محدد"},
    {src: "https://fatthatmablog.wordpress.com/wp-content/uploads/2025/11/08-1.png", alt: "زمن متغير"}
  ],
  3: [
    {src: "https://fatthatmablog.wordpress.com/wp-content/uploads/2025/11/01-2.png", alt: "حيوان أليف يتكلم"},
    {src: "https://fatthatmablog.wordpress.com/wp-content/uploads/2025/11/02-2.png", alt: "رسالة غامضة"},
    {src: "https://fatthatmablog.wordpress.com/wp-content/uploads/2025/11/03-2.png", alt: "اكتشاف مفاجئ"},
    {src: "https://fatthatmablog.wordpress.com/wp-content/uploads/2025/11/04-2.png", alt: "طقس غريب"},
    {src: "https://fatthatmablog.wordpress.com/wp-content/uploads/2025/11/05-2.png", alt: "حلم غريب"},
    {src: "https://fatthatmablog.wordpress.com/wp-content/uploads/2025/11/06-2.png", alt: "زيارة غير متوقعة"},
    {src: "https://fatthatmablog.wordpress.com/wp-content/uploads/2025/11/07-2.png", alt: "قوة خارقة"},
    {src: "https://fatthatmablog.wordpress.com/wp-content/uploads/2025/11/08-2.png", alt: "كائن غريب"}
  ],
  4: [
    {src: "https://fatthatmablog.wordpress.com/wp-content/uploads/2025/11/01-3.png", alt: "البطل/البطلة"},
    {src: "https://fatthatmablog.wordpress.com/wp-content/uploads/2025/11/02-3.png", alt: "صديق مقرب"},
    {src: "https://fatthatmablog.wordpress.com/wp-content/uploads/2025/11/03-3.png", alt: "الشرير/الشريرة"},
    {src: "https://fatthatmablog.wordpress.com/wp-content/uploads/2025/11/04-3.png", alt: "الغريب"},
    {src: "https://fatthatmablog.wordpress.com/wp-content/uploads/2025/11/05-3.png", alt: "الطفل/الطفلة"},
    {src: "https://fatthatmablog.wordpress.com/wp-content/uploads/2025/11/06-3.png", alt: "الشخصية التاريخية"},
    {src: "https://fatthatmablog.wordpress.com/wp-content/uploads/2025/11/07-3.png", alt: "الحيوان"},
    {src: "https://fatthatmablog.wordpress.com/wp-content/uploads/2025/11/08-3.png", alt: "كائن خيالي"}
  ],
  5: [
    {src: "https://fatthatmablog.wordpress.com/wp-content/uploads/2025/11/02-4.png", alt: "الصداقة"},
    {src: "https://fatthatmablog.wordpress.com/wp-content/uploads/2025/11/04-4.png", alt: "الحب"},
    {src: "https://fatthatmablog.wordpress.com/wp-content/uploads/2025/11/05-4.png", alt: "الخسارة"},
    {src: "https://fatthatmablog.wordpress.com/wp-content/uploads/2025/11/06-4.png", alt: "النصر"},
    {src: "https://fatthatmablog.wordpress.com/wp-content/uploads/2025/11/07-4.png", alt: "الخيانة"},
    {src: "https://fatthatmablog.wordpress.com/wp-content/uploads/2025/11/08-4.png", alt: "الانتقام"},
    {src: "https://fatthatmablog.wordpress.com/wp-content/uploads/2025/11/09.png", alt: "الأسرة"},
    {src: "https://fatthatmablog.wordpress.com/wp-content/uploads/2025/11/10.png", alt: "النمو الشخصي"}
  ],
  6: [
    {src: "https://fatthatmablog.wordpress.com/wp-content/uploads/2025/11/01-4.png", alt: "في مكان مظلم"},
    {src: "https://fatthatmablog.wordpress.com/wp-content/uploads/2025/11/02-5.png", alt: "خلال عاصفة"},
    {src: "https://fatthatmablog.wordpress.com/wp-content/uploads/2025/11/03-4.png", alt: "في المدينة"},
    {src: "https://fatthatmablog.wordpress.com/wp-content/uploads/2025/11/04-5.png", alt: "في الطبيعة"},
    {src: "https://fatthatmablog.wordpress.com/wp-content/uploads/2025/11/05-5.png", alt: "في الحلم"},
    {src: "https://fatthatmablog.wordpress.com/wp-content/uploads/2025/11/06-5.png", alt: "في الماضي"},
    {src: "https://fatthatmablog.wordpress.com/wp-content/uploads/2025/11/07-5.png", alt: "في المستقبل"},
    {src: "https://fatthatmablog.wordpress.com/wp-content/uploads/2025/11/08-5.png", alt: "في مكان غير مألوف"}
  ]
};

// Single random pick
function pickRandom(category) {
  const arr = images[category];
  const img = document.getElementById("img" + category);
  const selected = arr[Math.floor(Math.random() * arr.length)];

  img.classList.remove("show");
  img.style.display = "none";

  setTimeout(() => {
    img.src = selected.src;
    img.alt = selected.alt;
    img.style.display = "block";
    img.classList.add("show");
  }, 50);

  closePicker(category);
}

// Manual picker
function openManualPicker(category) {
  const picker = document.getElementById("picker" + category);
  picker.innerHTML = "";

  images[category].forEach(item => {
    const card = document.createElement("img");
    card.src = item.src;
    card.alt = item.alt;
    card.onclick = () => selectManual(category, item);
    picker.appendChild(card);
  });

  picker.style.display = "grid";
}

function selectManual(category, item) {
  const img = document.getElementById("img" + category);
  img.src = item.src;
  img.alt = item.alt;
  img.style.display = "block";
  img.classList.add("show");
  closePicker(category);
}

function closePicker(category) {
  const picker = document.getElementById("picker" + category);
  if (picker) picker.style.display = "none";
}

// Randomize all
function randomizeAll() {
  const tarotContainer = document.getElementById("tarotContainer");
  tarotContainer.innerHTML = "";
  tarotContainer.style.display = "flex";
  tarotContainer.style.flexWrap = "wrap";
  tarotContainer.style.justifyContent = "center";
  tarotContainer.style.gap = "15px";
  tarotContainer.style.margin = "20px 0";
  tarotContainer.style.opacity = "1";

  // First, close all manual pickers
  for (let i = 1; i <= 6; i++) {
    closePicker(i);
  }

  // Select random images for each category
  for (let i = 1; i <= 6; i++) {
    const arr = images[i];
    const selected = arr[Math.floor(Math.random() * arr.length)];
    
    // Update the main image in the category
    const mainImg = document.getElementById("img" + i);
    mainImg.classList.remove("show");
    mainImg.style.display = "none";
    
    setTimeout(() => {
      mainImg.src = selected.src;
      mainImg.alt = selected.alt;
      mainImg.style.display = "block";
      mainImg.classList.add("show");
    }, 50);
    
    // Create image for tarot container
    const tarotImg = document.createElement("img");
    tarotImg.src = selected.src;
    tarotImg.alt = selected.alt;
    tarotImg.style.width = "150px";
    tarotImg.style.maxWidth = "90%";
    tarotImg.style.borderRadius = "6px";
    tarotImg.style.boxShadow = "0 4px 8px rgba(0,0,0,0.1)";
    tarotImg.style.opacity = "0";
    tarotImg.style.transform = "translateY(-20px)";
    tarotImg.style.transition = "opacity 0.4s ease, transform 0.4s ease";
    
    tarotContainer.appendChild(tarotImg);
    
    // Animate each card with a delay
    setTimeout(() => {
      tarotImg.style.opacity = "1";
      tarotImg.style.transform = "translateY(0)";
    }, i * 100);
  }
  
  // Hide the tarot container after 3 seconds
  setTimeout(() => {
    tarotContainer.style.opacity = "0";
    tarotContainer.style.transition = "opacity 0.5s ease";
    setTimeout(() => {
      tarotContainer.style.display = "none";
      tarotContainer.style.opacity = "1";
    }, 500);
  }, 3000);
}

// Reset all
function resetAll() {
  for (let i = 1; i <= 6; i++) {
    const img = document.getElementById("img" + i);
    if (img) {
      img.src = "";
      img.alt = "";
      img.style.display = "none";
      img.classList.remove("show");
    }
    closePicker(i);
  }

  const tarotContainer = document.getElementById("tarotContainer");
  tarotContainer.innerHTML = "";
  tarotContainer.style.display = "none";
  tarotContainer.style.opacity = "1";

  // hide story section
  document.getElementById("storySection").style.display = "none";
  
  // Clear story text
  document.getElementById("storyText").value = "";
}

// Done button
function doneAndExport() {
  const storyDiv = document.getElementById("storySection");
  storyDiv.style.display = "block";

  const finalRow = document.getElementById("finalRow");
  finalRow.innerHTML = "";
  finalRow.style.display = "flex";
  finalRow.style.flexWrap = "wrap";
  finalRow.style.justifyContent = "center";
  finalRow.style.gap = "10px";
  finalRow.style.marginBottom = "15px";

  // Create image elements for each category
  for (let i = 1; i <= 6; i++) {
    const imgSrc = document.getElementById("img" + i).src;
    if (imgSrc && imgSrc.trim() !== "") {
      const img = document.createElement("img");
      img.src = imgSrc;
      img.alt = document.getElementById("img" + i).alt;
      img.style.width = "150px";
      img.style.maxWidth = "90%";
      img.style.display = "block";
      finalRow.appendChild(img);
    }
  }
}

// Export story as PNG - FIXED VERSION
document.getElementById("savePNGBtn").addEventListener("click", function() {
  const saveBtn = this;
  const originalText = saveBtn.textContent;
  saveBtn.textContent = "جاري التحميل...";
  saveBtn.disabled = true;
  
  // Get story text
  const storyText = document.getElementById("storyText").value;
  
  // Collect selected cards with their alt text
  const selectedCards = [];
  for (let i = 1; i <= 6; i++) {
    const img = document.getElementById("img" + i);
    if (img && img.src && img.src.trim() !== "") {
      selectedCards.push({
        alt: img.alt || `البطاقة ${i}`,
        category: i
      });
    }
  }
  
  // Category labels in Arabic
  const categoryLabels = ['التصنيف', 'التسلسل الزمني', 'العنصر غير المتوقع', 'الراوي', 'الموضوع', 'البداية'];
  
  // Create export wrapper
  const exportWrapper = document.createElement("div");
  exportWrapper.style.width = "900px";
  exportWrapper.style.padding = "30px";
  exportWrapper.style.background = "#fff";
  exportWrapper.style.fontFamily = "'Tajawal', sans-serif";
  exportWrapper.style.color = "#333";
  exportWrapper.style.direction = "rtl";
  exportWrapper.style.textAlign = "right";
  exportWrapper.style.border = "2px solid #a97852";
  exportWrapper.style.borderRadius = "12px";
  exportWrapper.style.boxSizing = "border-box";
  
  // Add logo
  const logo = document.createElement("img");
  logo.src = "https://fatthatmablog.wordpress.com/wp-content/uploads/2025/11/logo-copy.png";
  logo.style.width = "150px";
  logo.style.height = "auto";
  logo.style.display = "block";
  logo.style.margin = "0 auto 15px";
  exportWrapper.appendChild(logo);
  
  // Add title
  const title = document.createElement("h2");
  title.textContent = "تمرين الكتابة الجريئة";
  title.style.textAlign = "center";
  title.style.marginBottom = "10px";
  title.style.color = "#a97852";
  title.style.fontSize = "24px";
  exportWrapper.appendChild(title);
  
  // Add horizontal line
  const hr1 = document.createElement("hr");
  hr1.style.width = "100%";
  hr1.style.border = "1px solid #a97852";
  hr1.style.margin = "10px 0 20px";
  exportWrapper.appendChild(hr1);
  
  // Create container for category labels
  const labelsContainer = document.createElement("div");
  labelsContainer.style.display = "flex";
  labelsContainer.style.flexWrap = "wrap";
  labelsContainer.style.justifyContent = "center";
  labelsContainer.style.gap = "10px";
  labelsContainer.style.marginBottom = "10px";
  
  // Create container for card text (alt text)
  const cardsContainer = document.createElement("div");
  cardsContainer.style.display = "flex";
  cardsContainer.style.flexWrap = "wrap";
  cardsContainer.style.justifyContent = "center";
  cardsContainer.style.gap = "10px";
  cardsContainer.style.marginBottom = "30px";
  
  // Add category labels and card text
  selectedCards.forEach((card, index) => {
    // Add label
    const labelDiv = document.createElement("div");
    labelDiv.textContent = categoryLabels[card.category - 1];
    labelDiv.style.fontSize = "14px";
    labelDiv.style.fontWeight = "bold";
    labelDiv.style.color = "#a97852";
    labelDiv.style.textAlign = "center";
    labelDiv.style.width = "150px";
    labelsContainer.appendChild(labelDiv);
    
    // Add card text box (using alt text)
    const cardTextDiv = document.createElement("div");
    cardTextDiv.textContent = card.alt;
    cardTextDiv.style.width = "150px";
    cardTextDiv.style.height = "150px";
    cardTextDiv.style.display = "flex";
    cardTextDiv.style.alignItems = "center";
    cardTextDiv.style.justifyContent = "center";
    cardTextDiv.style.textAlign = "center";
    cardTextDiv.style.padding = "10px";
    cardTextDiv.style.border = "2px solid #a97852";
    cardTextDiv.style.borderRadius = "8px";
    cardTextDiv.style.backgroundColor = "#f8f3f0";
    cardTextDiv.style.fontSize = "16px";
    cardTextDiv.style.fontWeight = "500";
    cardTextDiv.style.color = "#333";
    cardTextDiv.style.boxSizing = "border-box";
    cardTextDiv.style.overflow = "hidden";
    cardTextDiv.style.wordWrap = "break-word";
    cardsContainer.appendChild(cardTextDiv);
  });
  
  exportWrapper.appendChild(labelsContainer);
  exportWrapper.appendChild(cardsContainer);
  
  // Add another horizontal line
  const hr2 = document.createElement("hr");
  hr2.style.width = "100%";
  hr2.style.border = "1px solid #a97852";
  hr2.style.margin = "10px 0 20px";
  exportWrapper.appendChild(hr2);
  
  // Add story title
  const storyTitle = document.createElement("h3");
  storyTitle.textContent = "قصتي:";
  storyTitle.style.color = "#a97852";
  storyTitle.style.marginBottom = "15px";
  storyTitle.style.fontSize = "20px";
  exportWrapper.appendChild(storyTitle);
  
  // Add story text - USING textContent (not innerHTML) for proper Arabic
  const storyDiv = document.createElement("div");
  storyDiv.textContent = storyText || "لم يتم كتابة قصة بعد.";
  storyDiv.style.fontFamily = "'Tajawal', sans-serif";
  storyDiv.style.fontSize = "18px";
  storyDiv.style.lineHeight = "1.8";
  storyDiv.style.whiteSpace = "pre-wrap";
  storyDiv.style.padding = "20px";
  storyDiv.style.border = "2px solid #a97852";
  storyDiv.style.borderRadius = "8px";
  storyDiv.style.minHeight = "200px";
  storyDiv.style.backgroundColor = "#f8f3f0";
  storyDiv.style.textAlign = "right";
  storyDiv.style.direction = "rtl";
  exportWrapper.appendChild(storyDiv);
  
  // Add footer
  const footer = document.createElement("div");
  footer.style.textAlign = "center";
  footer.style.marginTop = "30px";
  footer.style.paddingTop = "15px";
  footer.style.borderTop = "1px solid #ddd";
  footer.style.color = "#666";
  
  const footerText = document.createElement("p");
  footerText.textContent = "تم إنشاؤها بواسطة مدونة فاطمة";
  footerText.style.margin = "0";
  footer.appendChild(footerText);
  
  const dateText = document.createElement("p");
  dateText.textContent = "التاريخ: " + new Date().toLocaleDateString('ar-EG');
  dateText.style.margin = "5px 0 0";
  footer.appendChild(dateText);
  
  exportWrapper.appendChild(footer);
  
  // Append to body
  document.body.appendChild(exportWrapper);
  
  // Use html2canvas with proper options
  html2canvas(exportWrapper, {
    scale: 2,
    useCORS: true,
    backgroundColor: "#ffffff",
    logging: false
  }).then(function(canvas) {
    // Create download link
    const link = document.createElement("a");
    link.download = "قصتي_" + new Date().toISOString().slice(0,10) + ".png";
    link.href = canvas.toDataURL("image/png");
    
    // Trigger download
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    // Remove wrapper
    document.body.removeChild(exportWrapper);
    
    // Restore button
    saveBtn.textContent = originalText;
    saveBtn.disabled = false;
    
  }).catch(function(error) {
    console.error("Error generating image:", error);
    alert("حدث خطأ أثناء إنشاء الصورة. يرجى المحاولة مرة أخرى.");
    
    // Remove wrapper if it exists
    if (exportWrapper.parentNode) {
      document.body.removeChild(exportWrapper);
    }
    
    // Restore button
    saveBtn.textContent = originalText;
    saveBtn.disabled = false;
  });
});

// Preload logo for better performance
window.addEventListener('load', function() {
  const logo = new Image();
  logo.src = "https://fatthatmablog.wordpress.com/wp-content/uploads/2025/11/logo-copy.png";
});
